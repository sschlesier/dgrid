name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build SEA
        run: pnpm sea:build

      - name: Generate checksums
        run: |
          cd dist/release
          for f in *.dmg; do
            shasum -a 256 "$f" > "$f.sha256"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dgrid-darwin-arm64
          path: |
            dist/release/*.dmg
            dist/release/*.sha256

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build SEA
        run: pnpm sea:build

      - name: Generate checksums
        shell: pwsh
        run: |
          Get-ChildItem dist/release/*.zip | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($_.Name)" | Out-File -Encoding ascii "$($_.FullName).sha256"
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dgrid-win32-x64
          path: |
            dist/release/*.zip
            dist/release/*.sha256

  release:
    needs: [build, build-windows]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.sha256
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout homebrew-dgrid
        uses: actions/checkout@v4
        with:
          repository: sschlesier/homebrew-dgrid
          path: homebrew-tap
          token: ${{ secrets.HOMEBREW_PUSH_TOKEN }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dgrid-darwin-arm64
          path: artifacts

      - name: Update Cask
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          SHA256=$(awk '{print $1}' artifacts/*.sha256)

          CASK=homebrew-tap/Casks/dgrid.rb
          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$CASK"
          sed -i "s/sha256 \".*\"/sha256 \"${SHA256}\"/" "$CASK"
          sed -i "/^  revision /d" "$CASK"

          echo "Updated Cask to version ${VERSION} with sha256 ${SHA256}"
          cat "$CASK"

      - name: Push changes
        run: |
          cd homebrew-tap
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          if git diff --quiet Casks/dgrid.rb; then
            echo "No changes to cask"
            exit 0
          fi

          git add Casks/dgrid.rb
          git commit -m "Update dgrid to ${GITHUB_REF#refs/tags/}"
          git push origin main
